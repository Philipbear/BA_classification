import pandas as pd
from massql import msql_engine


ALL_MASSQL_QUERIES = {
    # dihydroxy
    'Dihydroxy': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=339.27:TOLERANCEMZ=0.01:INTENSITYPERCENT=5 AND MS2PROD=321.26:TOLERANCEMZ=0.01:INTENSITYPERCENT=5 AND MS2PREC=X AND MS2PROD=X-374.2894:TOLERANCEMZ=0.01:INTENSITYPERCENT=5",
    '1-OH-Sidechain; 1-OH-core_1': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=257.226:TOLERANCEPPM=10:INTENSITYPERCENT=40",
    '1-OH-Sidechain; 1-OH-core_2': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=257.226:TOLERANCEPPM=10:INTENSITYPERCENT=2 AND MS2MZ=147.117:TOLERANCEPPM=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=149.131:TOLERANCEPPM=10:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=30 AND MS2MZ=257.226:TOLERANCEPPM=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=161.132:TOLERANCEPPM=10:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=30",
    '1-OH-Sidechain; 1-OH-core_3': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=257.226:TOLERANCEPPM=10:INTENSITYPERCENT=2 AND MS2MZ=147.117:TOLERANCEPPM=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=149.131:TOLERANCEPPM=10:INTENSITYMATCH=Y*3:INTENSITYMATCHPERCENT=35",
    '1-ketone': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=161.132:TOLERANCEPPM=20:INTENSITYPERCENT=95",
    '3,12a-OH; 7,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=211.147:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.6:INTENSITYMATCHPERCENT=80",
    '3,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=243.174:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=239.179:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=30",
    '7,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=243.174:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=239.179:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.25:INTENSITYMATCHPERCENT=30",
    '3,7-OH; 3,6-OH; 3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=211.147:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*4.2:INTENSITYMATCHPERCENT=40",
    '3,7-OH; 3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*2:INTENSITYMATCHPERCENT=20",
    '3,6-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.7:INTENSITYMATCHPERCENT=60",
    '3,7-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=175.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.5:INTENSITYMATCHPERCENT=30",
    '3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=175.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=20"
}


def massql_filter(input_mgf, massql_queries=ALL_MASSQL_QUERIES):

    out_df = []
    # process the queries
    for query_name, input_query in massql_queries.items():
        results_df = msql_engine.process_query(input_query, input_mgf)
        if len(results_df) == 0:
            out_df.append({'query': query_name, 'scan_list': 'NA'})
            continue
        passed_scan_ls = results_df['scan'].values.tolist()
        passed_scan_ls = [int(x) for x in passed_scan_ls]
        out_df.append({'query': query_name, 'scan_list': passed_scan_ls})

    # save the result
    out_name = input_mgf.replace('.mgf', '_massql.tsv')
    out_df = pd.DataFrame(out_df)
    out_df.to_csv(out_name, sep='\t', index=False)


# actually run the code, a tsv file will be generated in the same folder as mgf
massql_filter(input_mgf='data/BILELIB19_corrected.mgf', massql_queries=ALL_MASSQL_QUERIES)


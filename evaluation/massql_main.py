import pandas as pd
from massql import msql_engine

ALL_MASSQL_QUERIES = {
    'Monohydroxy': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=341.28:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PROD=323.27:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PREC=X AND MS2PROD=X-358.2871:TOLERANCEMZ=0.01:INTENSITYPERCENT=2",
    '3-OH': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=259.2050:TOLERANCEPPM=20:INTENSITYPERCENT=10",
    '3a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=177.127:TOLERANCEPPM=20:INTENSITYPERCENT=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=241.194:TOLERANCEPPM=20:INTENSITYMATCH>Y*0.5:INTENSITYMATCHPERCENT=20",
    '7a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=161.09:TOLERANCEPPM=5:INTENSITYPERCENT=0.1",
    '7b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=177.127:TOLERANCEPPM=20:INTENSITYPERCENT=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=241.194:TOLERANCEPPM=20:INTENSITYMATCH<Y*0.2:INTENSITYMATCHPERCENT=30",

    # dihydroxy
    'Dihydroxy': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=339.27:TOLERANCEMZ=0.01:INTENSITYPERCENT=5 AND MS2PROD=321.26:TOLERANCEMZ=0.01:INTENSITYPERCENT=5 AND MS2PREC=X AND MS2PROD=X-374.2894:TOLERANCEMZ=0.01:INTENSITYPERCENT=5",
    '1-OH-Sidechain; 1-OH-core_1': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=257.226:TOLERANCEPPM=10:INTENSITYPERCENT=40",
    '1-OH-Sidechain; 1-OH-core_2': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=257.226:TOLERANCEPPM=10:INTENSITYPERCENT=2 AND MS2MZ=147.117:TOLERANCEPPM=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=149.131:TOLERANCEPPM=10:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=30 AND MS2MZ=257.226:TOLERANCEPPM=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=161.132:TOLERANCEPPM=10:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=30",
    '1-OH-Sidechain; 1-OH-core_3': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=257.226:TOLERANCEPPM=10:INTENSITYPERCENT=2 AND MS2MZ=147.117:TOLERANCEPPM=10:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=149.131:TOLERANCEPPM=10:INTENSITYMATCH=Y*3:INTENSITYMATCHPERCENT=35",
    '1-ketone': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=161.132:TOLERANCEPPM=20:INTENSITYPERCENT=95",
    '3,12a-OH; 7,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=211.147:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.6:INTENSITYMATCHPERCENT=80",
    '3,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=243.174:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=239.179:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=30",
    '7,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=243.174:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=239.179:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.25:INTENSITYMATCHPERCENT=30",
    '3,7-OH; 3,6-OH; 3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=211.147:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*4.2:INTENSITYMATCHPERCENT=40",
    '3,7-OH; 3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*2:INTENSITYMATCHPERCENT=20",
    '3,6-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=201.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.7:INTENSITYMATCHPERCENT=60",
    '3,7-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=175.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.5:INTENSITYMATCHPERCENT=30",
    '3,12b-OH; 7,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=175.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=20",

    # trihydroxy
    'Trihydroxy': "QUERY scaninfo(MS2DATA) WHERE MS2PROD=337.25:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PROD=319.24:TOLERANCEMZ=0.01:INTENSITYPERCENT=2 AND MS2PREC=X AND MS2PROD=X-390.277:TOLERANCEMZ=0.01:INTENSITYPERCENT=2",
    '1-OH-Sidechain; 2-OH-core 1-DB-Sidechain; 2-OH-core': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=145.101:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=255.21:TOLERANCEPPM=20:INTENSITYMATCH=Y*1.6:INTENSITYMATCHPERCENT=60",
    '22D; 2-OH-core': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=145.101:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=255.21:TOLERANCEPPM=20:INTENSITYMATCH=Y*1.6:INTENSITYMATCHPERCENT=60 AND MS2PROD = 255.21:TOLERANCEPPM=20:INTENSITYPERCENT=90",
    '22S; 2-OH-core': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=145.101:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=255.21:TOLERANCEPPM=20:INTENSITYMATCH=Y*1.6:INTENSITYMATCHPERCENT=60 AND MS2MZ=171.117:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=X*0.95:INTENSITYMATCHPERCENT=10",
    '23R; 2-OH-core': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=145.101:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=255.21:TOLERANCEPPM=20:INTENSITYMATCH=Y*1.6:INTENSITYMATCHPERCENT=60 AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=201.164:TOLERANCEPPM=20:INTENSITYMATCH=X*4:INTENSITYMATCHPERCENT=30",
    '3a7k': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=337.25:TOLERANCEPPM=20:INTENSITYPERCENT=2 AND MS2MZ=319.24:TOLERANCEPPM=20:INTENSITYPERCENT=2 AND MS2MZ=211.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=213.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.7:INTENSITYMATCHPERCENT=20 AND MS2PROD=355.2632:TOLERANCEPPM=20:INTENSITYPERCENT=5",
    '3k7a': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=337.25:TOLERANCEPPM=20:INTENSITYPERCENT=2 AND MS2MZ=319.24:TOLERANCEPPM=20:INTENSITYPERCENT=2 AND MS2MZ=295.242:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=319.242:TOLERANCEPPM=20:INTENSITYMATCH=Y*2:INTENSITYMATCHPERCENT=20 AND MS2PROD=355.2632:TOLERANCEPPM=20:INTENSITYPERCENT=2",
    '3a12k': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=337.25:TOLERANCEPPM=20:INTENSITYPERCENT=2 AND MS2MZ=319.24:TOLERANCEPPM=20:INTENSITYPERCENT=2 AND MS2MZ=145.101:TOLERANCEPPM=20:INTENSITYPERCENT=80 AND MS2MZ=309.257:TOLERANCEPPM=20:INTENSITYPERCENT=40 AND MS2PROD=355.2632:TOLERANCEPPM=20:INTENSITYPERCENT=10",
    '3k12a': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=337.25:TOLERANCEPPM=20:INTENSITYPERCENT=2 AND MS2MZ=319.24:TOLERANCEPPM=20:INTENSITYPERCENT=2 AND MS2PROD=355.2632:TOLERANCEPPM=20:INTENSITYPERCENT=10",
    '3,7b,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=185.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=Y*5:INTENSITYMATCHPERCENT=20",
    '3,7a,12b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=107.086:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=105.07:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.6:INTENSITYMATCHPERCENT=20 AND MS2MZ=209.132:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=X*8:INTENSITYMATCHPERCENT=30",
    '3,7b,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=91.055:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=189.127:TOLERANCEPPM=20:INTENSITYMATCH=Y*4:INTENSITYMATCHPERCENT=30 AND MS2MZ=227.143:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=159.117:TOLERANCEPPM=20:INTENSITYMATCH=X*0.8:INTENSITYMATCHPERCENT=40",
    '3,7a,12a-OH/Allo-3,7a,12a': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=209.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.7:INTENSITYMATCHPERCENT=30",
    '3,7a,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=209.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.7:INTENSITYMATCHPERCENT=30 AND MS2MZ=209.132:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=X*0.2:INTENSITYMATCHPERCENT=10",
    'Allo-3,7a,12a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=209.132:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.7:INTENSITYMATCHPERCENT=30 AND MS2MZ=209.132:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=X*0.4:INTENSITYMATCHPERCENT=30",
    '3,6,7-OH; 3,4,7-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=191.143:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=225.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*1.2:INTENSITYMATCHPERCENT=60",
    '3,4,7-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=213.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=10",
    '3,6,7-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=199.148:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=213.163:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.7:INTENSITYMATCHPERCENT=10",
    '3,6b,7b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=185.132:TOLERANCEPPM=20:INTENSITYMATCH=X*0.8:INTENSITYMATCHPERCENT=10",
    '3,6a,7a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=173.132:TOLERANCEPPM=20:INTENSITYMATCH=X:INTENSITYMATCHREFERENCE AND MS2MZ=185.132:TOLERANCEPPM=20:INTENSITYMATCH=X*1:INTENSITYMATCHPERCENT=5",
    '3,6b,7a-OH; 3,6a,7b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=159.117:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=161.132:TOLERANCEPPM=20:INTENSITYMATCH=Y*0.9:INTENSITYMATCHPERCENT=10",
    '3,6b,7a-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=125.096:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=309.257:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=20",
    '3,6a,7b-OH': "QUERY scaninfo(MS2DATA) WHERE MS2MZ=125.096:TOLERANCEPPM=20:INTENSITYMATCH=Y:INTENSITYMATCHREFERENCE AND MS2MZ=309.257:TOLERANCEPPM=20:INTENSITYMATCH=Y*1:INTENSITYMATCHPERCENT=20"
}

def massql_filter(input_mgf, massql_queries=ALL_MASSQL_QUERIES):

    out_df = []
    # process the queries
    for query_name, input_query in massql_queries.items():
        results_df = msql_engine.process_query(input_query, input_mgf)
        if len(results_df) == 0:
            out_df.append({'query': query_name, 'scan_list': 'NA'})
            continue
        passed_scan_ls = results_df['scan'].values.tolist()
        passed_scan_ls = [int(x) for x in passed_scan_ls]
        out_df.append({'query': query_name, 'scan_list': passed_scan_ls})

    # save the result
    out_name = input_mgf.replace('.mgf', '_massql.tsv')
    out_df = pd.DataFrame(out_df)
    out_df.to_csv(out_name, sep='\t', index=False)


# actually run the code, a tsv file will be generated in the same folder as mgf
massql_filter(input_mgf='data/BILELIB19_corrected.mgf', massql_queries=ALL_MASSQL_QUERIES)

